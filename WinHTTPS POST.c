#include <stdio.h>
#include <windows.h>
#include <winhttp.h>

static int http_put(wchar_t *host, short port, wchar_t *path, char *data, size_t size)
{
    int code = 0;
    HINTERNET hSession = WinHttpOpen(NULL,
                                     WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,
                                     WINHTTP_NO_PROXY_NAME,
                                     WINHTTP_NO_PROXY_BYPASS, 0);
    if (!hSession)
    {
        code = 1;
        goto end;
    }
    HINTERNET hConnect = WinHttpConnect(hSession, host, port, 0);
    if (!hConnect)
    {
        code = 2;
        goto end;
    }
    HINTERNET hRequest = WinHttpOpenRequest(hConnect, L"PUT", L"/",
                                            NULL, WINHTTP_NO_REFERER,
                                            WINHTTP_DEFAULT_ACCEPT_TYPES,
                                            WINHTTP_FLAG_SECURE);
    if (!hRequest)
    {
        code = 3;
        goto end;
    }
    DWORD dwFlags =
        SECURITY_FLAG_IGNORE_UNKNOWN_CA |
        SECURITY_FLAG_IGNORE_CERT_WRONG_USAGE |
        SECURITY_FLAG_IGNORE_CERT_CN_INVALID |
        SECURITY_FLAG_IGNORE_CERT_DATE_INVALID;
    if (!WinHttpSetOption(
            hRequest,
            WINHTTP_OPTION_SECURITY_FLAGS,
            &dwFlags,
            sizeof(dwFlags)))
    {
        code = 4;
        goto end;
    }
    if (!WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0,
                            WINHTTP_NO_REQUEST_DATA, 0,
                            size, 0))
    {
        code = 5;
        goto end;
    }
    DWORD dwBytesWritten;
    if (!WinHttpWriteData(hRequest, data, size, &dwBytesWritten))
    {
        code = 6;
        goto end;
    }
end:
    WinHttpCloseHandle(hRequest);
    WinHttpCloseHandle(hConnect);
    WinHttpCloseHandle(hSession);
    return code;
}

int main(void)
{
    char *popit = "yo dawg";
    int code = http_put(L"localhost", 8080, L"/", popit, sizeof(popit) - 1);
    if (code)
    {
        printf("error: %d\n", code);
    }

    return 0;
}
